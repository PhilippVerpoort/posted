
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://posted.verpoort.online/develop/code/python/noslag/">
      
      
        <link rel="prev" href="../masking/">
      
      
        <link rel="next" href="../read/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>noslag - POSTED Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#python.posted.noslag" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="POSTED Documentation" class="md-header__button md-logo" aria-label="POSTED Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            POSTED Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              noslag
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/PhilippVerpoort/posted/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    POSTED
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../installation/" class="md-tabs__link">
        
  
    
  
  Installation

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../../methodology/" class="md-tabs__link">
        
  
    
  
  Methodology

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../tutorials/python/overview/" class="md-tabs__link">
          
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../columns/" class="md-tabs__link">
          
  
    
  
  Code

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="POSTED Documentation" class="md-nav__button md-logo" aria-label="POSTED Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    POSTED Documentation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/PhilippVerpoort/posted/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    POSTED
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../installation/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Installation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../methodology/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Methodology
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Tutorials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tutorials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/python/overview/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Main POSTED tutorial for python
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Code
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Code
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_1" checked>
        
          
          <label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Python
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_1">
            <span class="md-nav__icon md-icon"></span>
            Python
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../columns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    columns
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../definitions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    definitions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../masking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    masking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    noslag
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    noslag
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag" class="md-nav__link">
    <span class="md-ellipsis">
      noslag
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag.DataSet" class="md-nav__link">
    <span class="md-ellipsis">
      DataSet
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DataSet">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python.posted.noslag.DataSet.data" class="md-nav__link">
    <span class="md-ellipsis">
      data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python.posted.noslag.DataSet.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python.posted.noslag.DataSet.aggregate" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python.posted.noslag.DataSet.normalise" class="md-nav__link">
    <span class="md-ellipsis">
      normalise
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#python.posted.noslag.DataSet.select" class="md-nav__link">
    <span class="md-ellipsis">
      select
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag.HarmoniseMappingFailure" class="md-nav__link">
    <span class="md-ellipsis">
      HarmoniseMappingFailure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HarmoniseMappingFailure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#python.posted.noslag.HarmoniseMappingFailure.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag.collect_files" class="md-nav__link">
    <span class="md-ellipsis">
      collect_files
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag.combine_units" class="md-nav__link">
    <span class="md-ellipsis">
      combine_units
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag.normalise_units" class="md-nav__link">
    <span class="md-ellipsis">
      normalise_units
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#python.posted.noslag.normalise_values" class="md-nav__link">
    <span class="md-ellipsis">
      normalise_values
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../read/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    read
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../sources/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    sources
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../tedf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tedf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../units/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    units
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_2" >
        
          
          <label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    R
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5_2">
            <span class="md-nav__icon md-icon"></span>
            R
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/columns/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    columns
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/definitions/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    definitions
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/masking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    masking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/noslag/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    noslag
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/read/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    read
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/tedf/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    tedf
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../R/modules/units/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    units
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>noslag</h1>

<div class="doc doc-object doc-module">



<a id="python.posted.noslag"></a>
    <div class="doc doc-contents first">



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="python.posted.noslag.DataSet" class="doc doc-heading">
            <code>DataSet</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="posted.tedf.TEBase">TEBase</span></code></p>


      <p>Class to store, normalise, select and aggregate DataSets</p>


<details class="-parameters" open>
  <summary>Parameters</summary>
  <p>parent_variable: str
    Variable to collect Data on
include_databases: Optional[list|str] | tuple[str]], optional
    Databases to load from
file_paths: Optional[list[path]], optional
    Paths to load data from
check_inconsistencies: bool, optional
    Wether to check for inconsistencies
data: Optional[pd.DataFrame], optional
    Specific data to include in the dataset</p>
</details>
              <details class="quote">
                <summary>Source code in <code>python/posted/noslag.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DataSet</span><span class="p">(</span><span class="n">TEBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Class to store, normalise, select and aggregate DataSets</span>
<span class="sd">     Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent_variable: str</span>
<span class="sd">        Variable to collect Data on</span>
<span class="sd">    include_databases: Optional[list|str] | tuple[str]], optional</span>
<span class="sd">        Databases to load from</span>
<span class="sd">    file_paths: Optional[list[path]], optional</span>
<span class="sd">        Paths to load data from</span>
<span class="sd">    check_inconsistencies: bool, optional</span>
<span class="sd">        Wether to check for inconsistencies</span>
<span class="sd">    data: Optional[pd.DataFrame], optional</span>
<span class="sd">        Specific data to include in the dataset</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_df</span><span class="p">:</span> <span class="kc">None</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">_columns</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AbstractColumnDefinition</span><span class="p">]</span>
    <span class="n">_fields</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AbstractFieldDefinition</span><span class="p">]</span>
    <span class="n">_masks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Mask</span><span class="p">]</span>

    <span class="c1"># initialise</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">parent_variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                 <span class="n">include_databases</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">file_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">check_inconsistencies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Initialise parent class and fields, load data from specified databases and files</span>


<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">TEBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_variable</span><span class="p">)</span>

        <span class="c1"># initialise fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">base_columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">col_id</span><span class="p">:</span> <span class="n">field</span>
            <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">AbstractFieldDefinition</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Load data if provided, otherwise load from TEDataFiles</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># read TEDataFiles and combine into dataset</span>
            <span class="n">include_databases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">include_databases</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_databases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_files</span><span class="p">(</span><span class="n">include_databases</span><span class="p">,</span> <span class="n">file_paths</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">check_inconsistencies</span><span class="p">)</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;str: Get or set dataframe&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">df</span>


    <span class="k">def</span> <span class="nf">_load_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">include_databases</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">file_paths</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">],</span> <span class="n">check_inconsistencies</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="c1"># Load TEDFs and compile into NSHADataSet</span>

        <span class="n">files</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">TEDF</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># collect TEDF and append to list</span>
        <span class="n">collected_files</span> <span class="o">=</span> <span class="n">collect_files</span><span class="p">(</span><span class="n">parent_variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_variable</span><span class="p">,</span> <span class="n">include_databases</span><span class="o">=</span><span class="n">include_databases</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file_variable</span><span class="p">,</span> <span class="n">file_database_id</span> <span class="ow">in</span> <span class="n">collected_files</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TEDF</span><span class="p">(</span><span class="n">parent_variable</span><span class="o">=</span><span class="n">file_variable</span><span class="p">,</span> <span class="n">database_id</span><span class="o">=</span><span class="n">file_database_id</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">file_paths</span><span class="p">:</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TEDF</span><span class="p">(</span><span class="n">parent_variable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_variable</span><span class="p">,</span> <span class="n">file_path</span><span class="o">=</span><span class="n">file_path</span><span class="p">))</span>

        <span class="c1"># raise exception if no TEDF can be loaded</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No TEDF to load for variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_variable</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

        <span class="c1"># get fields and masks from databases</span>
        <span class="n">files_vars</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="o">.</span><span class="n">parent_variable</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">files_vars</span><span class="p">:</span>
            <span class="n">new_fields</span><span class="p">,</span> <span class="n">new_comments</span> <span class="o">=</span> <span class="n">read_fields</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">new_fields</span> <span class="o">|</span> <span class="n">new_comments</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot load TEDFs due to multiple columns with same ID defined: </span><span class="si">{</span><span class="n">col_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="n">new_fields</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">new_fields</span> <span class="o">|</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">|</span> <span class="n">new_comments</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="o">+=</span> <span class="n">read_masks</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

        <span class="c1"># load all TEDFs: load from file, check for inconsistencies (if requested), expand cases and variables</span>
        <span class="n">file_dfs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="c1"># load</span>
            <span class="n">f</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

            <span class="c1"># check for inconsistencies</span>
            <span class="k">if</span> <span class="n">check_inconsistencies</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">check</span><span class="p">()</span>

            <span class="c1"># obtain dataframe and insert column parent_variable</span>
            <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">df_tmp</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;parent_variable&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">parent_variable</span><span class="p">)</span>

            <span class="c1"># append to dataframe list</span>
            <span class="n">file_dfs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_tmp</span><span class="p">)</span>

        <span class="c1"># compile dataset from the dataframes loaded from the individual files</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">file_dfs</span><span class="p">)</span>

        <span class="c1"># query relevant variables</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;parent_variable==&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_variable</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># drop entries with unknown variables and warn</span>
        <span class="k">for</span> <span class="n">var_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">):</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span> <span class="o">&amp;</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parent_variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">var_type</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown </span><span class="si">{</span><span class="n">var_type</span><span class="si">}</span><span class="s2">, so dropping rows:</span><span class="se">\n</span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span><span class="w"> </span><span class="n">var_type</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># return</span>
        <span class="k">return</span> <span class="n">data</span>


    <span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        normalise data: default reference units, reference value equal to 1.0, default reported units</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        override: Optional[dict[str,str]], optional</span>
<span class="sd">            Dictionary with key, value pairs of variables to override</span>
<span class="sd">        inplace: bool, optional</span>
<span class="sd">            Wether to do the normalisation in place</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            if inplace is false, returns normalised dataframe&#39;&#39;&#39;</span>
        <span class="n">normalised</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">normalised</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">normalised</span>

    <span class="k">def</span> <span class="nf">_normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">override</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># get overridden var specs</span>
        <span class="n">var_flow_ids</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">var_specs</span><span class="p">[</span><span class="s1">&#39;flow_id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;flow_id&#39;</span> <span class="ow">in</span> <span class="n">var_specs</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_specs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">var_units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_name</span><span class="p">:</span> <span class="n">var_specs</span><span class="p">[</span><span class="s1">&#39;default_unit&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">var_specs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span> <span class="o">|</span> <span class="n">override</span>

        <span class="c1"># normalise reference units, normalise reference values, and normalise reported units</span>
        <span class="n">normalised</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> \
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">normalise_units</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;reference&#39;</span><span class="p">,</span> <span class="n">var_units</span><span class="o">=</span><span class="n">var_units</span><span class="p">,</span> <span class="n">var_flow_ids</span><span class="o">=</span><span class="n">var_flow_ids</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">normalise_values</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">normalise_units</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;reported&#39;</span><span class="p">,</span> <span class="n">var_units</span><span class="o">=</span><span class="n">var_units</span><span class="p">,</span> <span class="n">var_flow_ids</span><span class="o">=</span><span class="n">var_flow_ids</span><span class="p">)</span>

        <span class="c1"># return normalised data and variable units</span>
        <span class="k">return</span> <span class="n">normalised</span><span class="p">,</span> <span class="n">var_units</span>

    <span class="c1"># prepare data for selection</span>
    <span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
               <span class="n">drop_singular_fields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="n">extrapolate_period</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
               <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Select desired data from the dataframe</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        override: Optional[dict[str, str]]</span>
<span class="sd">            Dictionary with key, value paris of variables to override</span>
<span class="sd">        drop_singular_fields: bool, optional</span>
<span class="sd">            If True, drop custom fields with only one value</span>
<span class="sd">        extrapolate_period: bool, optional</span>
<span class="sd">            If True, extrapolate values by extrapolation, if no value for this period is given</span>
<span class="sd">        **field_vals_select</span>
<span class="sd">            IDs of values to select</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame with selected Values</span>
<span class="sd">            &#39;&#39;&#39;</span>
        <span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_references</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span>
            <span class="n">override</span><span class="p">,</span>
            <span class="n">drop_singular_fields</span><span class="p">,</span>
            <span class="n">extrapolate_period</span><span class="p">,</span>
            <span class="o">**</span><span class="n">field_vals_select</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">selected</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">selected</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">),</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">var_references</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]],</span>
                <span class="n">drop_singular_fields</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="n">extrapolate_period</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
        <span class="c1"># start from normalised data</span>
        <span class="n">normalised</span><span class="p">,</span> <span class="n">var_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="n">normalised</span>

        <span class="c1"># drop unit columns and reference value column</span>
        <span class="n">selected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_unit&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_value&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># drop columns containing comments and uncertainty field (which is currently unsupported)</span>
        <span class="n">selected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">col_type</span> <span class="o">==</span> <span class="s1">&#39;comment&#39;</span>
            <span class="p">],</span>
            <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># add parent variable as prefix to other variable columns</span>
        <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;parent_variable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span>
        <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;parent_variable&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span>
        <span class="n">selected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;parent_variable&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># raise exception if fields listed in arguments that are unknown</span>
        <span class="k">for</span> <span class="n">field_id</span> <span class="ow">in</span> <span class="n">field_vals_select</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">field_id</span> <span class="o">==</span> <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">field_id</span><span class="si">}</span><span class="s2">&#39; does not exist and cannot be used for selection.&quot;</span><span class="p">)</span>

        <span class="c1"># order fields for selection: period must be expanded last due to the interpolation</span>
        <span class="n">fields_select</span> <span class="o">=</span> <span class="p">({</span><span class="n">col_id</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">field_vals_select</span><span class="p">}</span> <span class="o">|</span>
                         <span class="p">{</span><span class="n">col_id</span><span class="p">:</span> <span class="n">field</span> <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">col_id</span> <span class="o">!=</span> <span class="s1">&#39;period&#39;</span> <span class="ow">and</span> <span class="n">col_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_vals_select</span><span class="p">}</span> <span class="o">|</span>
                         <span class="p">{</span><span class="s1">&#39;period&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">[</span><span class="s1">&#39;period&#39;</span><span class="p">]})</span>

        <span class="c1"># select and expand fields</span>
        <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields_select</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">field_vals</span> <span class="o">=</span> <span class="n">field_vals_select</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span> <span class="k">if</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">field_vals_select</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">select_and_expand</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field_vals</span><span class="p">,</span> <span class="n">extrapolate_period</span><span class="o">=</span><span class="n">extrapolate_period</span><span class="p">)</span>

        <span class="c1"># drop custom fields with only one value if specified in method argument</span>
        <span class="k">if</span> <span class="n">drop_singular_fields</span><span class="p">:</span>
            <span class="n">selected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span>
                <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">CustomFieldDefinition</span><span class="p">)</span> <span class="ow">and</span> <span class="n">selected</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">2</span>
            <span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># apply mappings</span>
        <span class="n">selected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_mappings</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">)</span>

        <span class="c1"># drop rows with failed mappings</span>
        <span class="n">selected</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># get map of variable references</span>
        <span class="n">var_references</span> <span class="o">=</span> <span class="n">selected</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">([</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">])</span> \
            <span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span> \
            <span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">)[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span>

        <span class="c1"># Check for multiple reference variables per reported variable</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">var_references</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_unique</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Multiple reference variables per reported variable found: </span><span class="si">{</span><span class="n">var_references</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">var_references</span> <span class="o">=</span> <span class="n">var_references</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

        <span class="c1"># Remove &#39;reference_variable column</span>
        <span class="n">selected</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># strip off unit variants</span>
        <span class="n">var_units</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">variable</span><span class="p">:</span> <span class="n">unit</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">unit</span> <span class="ow">in</span> <span class="n">var_units</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>

        <span class="c1"># return</span>
        <span class="k">return</span> <span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_references</span>


    <span class="k">def</span> <span class="nf">_apply_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expanded</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">var_units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># apply mappings between entry types</span>
        <span class="c1"># list of columns to group by</span>
        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expanded</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="p">]</span>

        <span class="c1"># perform groupby and do not drop NA values</span>
        <span class="n">grouped</span> <span class="o">=</span> <span class="n">expanded</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># create return list</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># loop over groups</span>
        <span class="k">for</span> <span class="n">keys</span><span class="p">,</span> <span class="n">ids</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># get rows in group</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">,</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">expanded</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_cols</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># 1. convert FLH to OCF</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;|FLH&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

                <span class="c1"># Multiply &#39;value&#39; by conversion factor</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;/a&#39;</span><span class="p">,</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|FLH&#39;</span><span class="p">,</span> <span class="s1">&#39;|OCF&#39;</span><span class="p">)],</span>
                    <span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Replace &#39;|FLH&#39; with &#39;|OCF in &#39;variable&#39;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> \
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|FLH&#39;</span><span class="p">,</span> <span class="s1">&#39;|OCF&#39;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="c1"># 2. convert OPEX Fixed Relative to OPEX Fixed</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Relative&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

                <span class="c1"># Define a function to calculate the conversion factor</span>
                <span class="k">def</span> <span class="nf">calculate_conversion</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="n">conversion_factor</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span><span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]],</span> <span class="s1">&#39;dimensionless&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Relative&#39;</span><span class="p">,</span> <span class="s1">&#39;|CAPEX&#39;</span><span class="p">)]</span> <span class="o">+</span> <span class="s1">&#39;/a&#39;</span><span class="p">,</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Relative&#39;</span><span class="p">,</span> <span class="s1">&#39;|OPEX Fixed&#39;</span><span class="p">)]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;variable==&#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Relative&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;|CAPEX&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">))</span>
                    <span class="k">return</span> <span class="n">conversion_factor</span>

                <span class="c1"># Calcualte the conversion factor and update &#39;value&#39; for rows satisfying the condition</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_conversion</span><span class="p">(</span><span class="n">row</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Replace &#39;|OPEX Fixed Relative&#39; with &#39;|OPEX FIXED&#39; in &#39;variable&#39;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> \
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Relative&#39;</span><span class="p">,</span> <span class="s1">&#39;|OPEX Fixed&#39;</span><span class="p">)</span>

                <span class="c1"># Assign &#39;reference_variable&#39; based on modified &#39;variable&#39;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">rows</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;variable==&#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;|CAPEX&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Check if there are rows with null &#39;value&#39; after the operation</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">HarmoniseMappingFailure</span><span class="p">(</span>
                        <span class="n">expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()],</span>
                        <span class="s1">&#39;No CAPEX value matching a OPEX Fixed Relative value found.&#39;</span><span class="p">,</span>
                    <span class="p">))</span>

            <span class="c1"># 3. convert OPEX Fixed Specific to OPEX Fixed</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Specific&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>

                <span class="c1"># Define a function to calculate the conversion factor</span>
                <span class="k">def</span> <span class="nf">calculate_conversion</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="n">conversion_factor</span> <span class="o">=</span> <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;/a&#39;</span><span class="p">,</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Specific&#39;</span><span class="p">,</span> <span class="s1">&#39;|OPEX Fixed&#39;</span><span class="p">)]</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="s1">&#39;/a&#39;</span><span class="p">,</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(Input|Output)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1 Capacity&#39;</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">])],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]][</span><span class="s1">&#39;flow_id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;flow_id&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Specific&#39;</span><span class="p">,</span> <span class="s1">&#39;|OCF&#39;</span><span class="p">)],</span>
                        <span class="s1">&#39;dimensionless&#39;</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">rows</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;variable==&#39;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Specific&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;|OCF&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">))</span>
                    <span class="k">return</span> <span class="n">conversion_factor</span>

                <span class="c1"># Calculate the conversion factor and update &#39;value&#39; for rows satisfying the condition</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_conversion</span><span class="p">(</span><span class="n">row</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># replace &#39;|OPEX Fixed Specific&#39; with &#39;|OPEX Fixed&#39; in &#39;variable&#39;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> \
                    <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;|OPEX Fixed Specific&#39;</span><span class="p">,</span> <span class="s1">&#39;|OPEX Fixed&#39;</span><span class="p">)</span>

                <span class="c1"># Assign &#39;reference_variable by replacing &#39;Input&#39; or &#39;Output&#39; with &#39;Input Capacity&#39; or &#39;Output Capacity&#39;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(Input|Output)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;\1 Capacity&#39;</span><span class="p">,</span> <span class="n">cell</span><span class="p">),</span>
                <span class="p">)</span>

                <span class="c1"># Check if there are any rows with null &#39;value&#39; after the opera</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">HarmoniseMappingFailure</span><span class="p">(</span>
                        <span class="n">expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()],</span>
                        <span class="s1">&#39;No OCF value matching a OPEX Fixed Specific value found.&#39;</span><span class="p">,</span>
                    <span class="p">))</span>

            <span class="c1"># 4. convert efficiencies (Output over Input) to demands (Input over Output)</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\|Output(?: Capacity)?\|&#39;</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\|Input(?: Capacity)?\|&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable_new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable_new&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable_new&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># 5. convert all references to primary output</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">(((</span><span class="n">rows</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\|Output(?: Capacity)?\|&#39;</span><span class="p">)</span> <span class="o">|</span>
                    <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\|Input(?: Capacity)?\|&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">notnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="kc">False</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="s1">&#39;default_reference&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">[</span><span class="n">var</span><span class="p">])</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">rows</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;default_reference&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s1">&#39;default_reference&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="p">)</span> <span class="o">!=</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">cond</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">regex_find</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;\|(Input|Output)(?: Capacity)?\|&#39;</span>
                <span class="n">regex_repl</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;|\1|&#39;</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable_new&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">var</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_var_specs</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="s1">&#39;default_reference&#39;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="c1"># Define function to calculate the conversion factor</span>
                <span class="k">def</span> <span class="nf">calculate_conversion</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                    <span class="n">conversion_factor</span> <span class="o">=</span>  <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;a*&#39;</span> <span class="k">if</span> <span class="s1">&#39;Capacity&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable_new&#39;</span><span class="p">]],</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex_find</span><span class="p">,</span> <span class="n">regex_repl</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable_new&#39;</span><span class="p">])],</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable_new&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="n">unit_convert</span><span class="p">(</span>
                        <span class="p">(</span><span class="s1">&#39;a*&#39;</span> <span class="k">if</span> <span class="s1">&#39;Capacity&#39;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]],</span>
                        <span class="n">var_units</span><span class="p">[</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex_find</span><span class="p">,</span> <span class="n">regex_repl</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">])],</span>
                        <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">*</span> <span class="n">rows</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;variable==&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex_find</span><span class="p">,</span><span class="w"> </span><span class="n">regex_repl</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&#39; &amp; &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;reference_variable==&#39;</span><span class="si">{</span><span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">regex_find</span><span class="p">,</span><span class="w"> </span><span class="n">regex_repl</span><span class="p">,</span><span class="w"> </span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable_new&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">df</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">df</span><span class="o">.</span><span class="n">empty</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="n">conversion_factor</span>

                <span class="c1"># Calculate the conversion factor and update &#39;value&#39; for rows satisfying the condition</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">calculate_conversion</span><span class="p">(</span><span class="n">row</span><span class="p">),</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span><span class="p">,</span> <span class="s1">&#39;reference_variable_new&#39;</span><span class="p">]</span>
                <span class="n">rows</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;reference_variable_new&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">HarmoniseMappingFailure</span><span class="p">(</span>
                        <span class="n">expanded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ids</span><span class="p">]</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">cond</span> <span class="o">&amp;</span> <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()],</span>
                        <span class="s1">&#39;No appropriate mapping found to convert row reference to primary output.&#39;</span><span class="p">,</span>
                    <span class="p">))</span>

            <span class="c1"># set missing columns from group</span>
            <span class="n">rows</span><span class="p">[</span><span class="n">group_cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">keys</span>

            <span class="c1"># add to return list</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="c1"># convert return list to dataframe and return</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">ret</span> <span class="k">else</span> <span class="n">expanded</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[]]</span>

    <span class="c1"># select data</span>
    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">drop_singular_fields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">extrapolate_period</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">agg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">masks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Mask</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">masks_database</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Aggregates data based on specified parameters, applies masks,</span>
<span class="sd">        and cleans up the resulting DataFrame.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        override: Optional[dict[str, str]]</span>
<span class="sd">            Dictionary with key, value paris of variables to override</span>
<span class="sd">        drop_singular_fields: bool, optional</span>
<span class="sd">            If True, drop custom fields with only one value</span>
<span class="sd">        extrapolate_period: bool, optional</span>
<span class="sd">            If True, extrapolate values by extrapolation, if no value for this period is given</span>
<span class="sd">        agg : Optional[str | list[str] | tuple[str]]</span>
<span class="sd">            Specifies which fields to aggregate over.</span>
<span class="sd">        masks : Optional[list[Mask]]</span>
<span class="sd">            Specifies a list of Mask objects that will be applied to the data during aggregation.</span>
<span class="sd">            These masks can be used to filter or weight the</span>
<span class="sd">            data based on certain conditions defined in the Mask objects.</span>
<span class="sd">        masks_database : bool, optional</span>
<span class="sd">            Determines whether to include masks from databases in the aggregation process.</span>
<span class="sd">            If set to `True`, masks from databases will be included along with any masks provided as function arguments.</span>
<span class="sd">            If set to `False`, only the masks provided as function argruments will be applied</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            The `aggregate` method returns a pandas DataFrame that has been cleaned up and aggregated based</span>
<span class="sd">            on the specified parameters and input data. The method performs aggregation over component</span>
<span class="sd">            fields and cases fields, applies weights based on masks, drops rows with NaN weights, aggregates</span>
<span class="sd">            with weights, inserts reference variables, sorts columns and rows, rounds values, and inserts</span>
<span class="sd">            units before returning the final cleaned and aggregated DataFrame.</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># get selection</span>
        <span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_references</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">override</span><span class="p">,</span>
                                                           <span class="n">extrapolate_period</span><span class="p">,</span>
                                                           <span class="n">drop_singular_fields</span><span class="p">,</span>
                                                           <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span>

        <span class="c1"># compile masks from databases and function argument into one list</span>
        <span class="k">if</span> <span class="n">masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Function argument &#39;masks&#39; must contain a list of posted.masking.Mask objects.&quot;</span><span class="p">)</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="k">if</span> <span class="n">masks_database</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="n">masks</span> <span class="ow">or</span> <span class="p">[])</span>

        <span class="c1"># aggregation</span>
        <span class="n">component_fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;component&#39;</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="n">component_fields</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
                <span class="n">agg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">agg</span> <span class="o">=</span> <span class="p">[</span><span class="n">agg</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field ID in argument &#39;agg&#39; must be a string but found: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field ID in argument &#39;agg&#39; is not a valid field: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># aggregate over component fields</span>
        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">agg</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">component_fields</span><span class="p">))</span>
        <span class="p">]</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="n">selected</span> \
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span> \
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># aggregate over cases fields</span>
        <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">columns</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">keys</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="c1"># set default weights to 1.0</span>
            <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

            <span class="c1"># update weights by applying masks</span>
            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                    <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mask</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

            <span class="c1"># drop all rows with weights equal to nan</span>
            <span class="n">rows</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># aggregate with weights</span>
                <span class="n">out</span> <span class="o">=</span> <span class="n">rows</span> \
                    <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span> \
                    <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cols</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
                        <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]),</span>
                    <span class="p">}))</span>

                <span class="c1"># add to return list</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">aggregated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># insert reference variables</span>
        <span class="n">var_ref_unique</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">var_references</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">var_references</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="n">agg_append</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ref_var</span> <span class="ow">in</span> <span class="n">var_ref_unique</span><span class="p">:</span>
            <span class="n">agg_append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
                <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ref_var</span><span class="p">],</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
            <span class="p">}</span> <span class="o">|</span> <span class="p">{</span>
                <span class="n">col_id</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">aggregated</span>
            <span class="p">}))</span>
        <span class="k">if</span> <span class="n">agg_append</span><span class="p">:</span>
            <span class="n">agg_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">agg_append</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">col_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">agg_append</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">select_and_expand</span><span class="p">(</span><span class="n">agg_append</span><span class="p">,</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">aggregated</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">agg_append</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># convert return list to dataframe, reset index, and clean up</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">aggregated</span><span class="p">,</span> <span class="n">agg_append</span><span class="p">]),</span> <span class="n">var_units</span><span class="p">)</span>

    <span class="c1"># clean up: sort columns and rows, round values, insert units</span>
    <span class="k">def</span> <span class="nf">_cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">var_units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="c1"># sort columns and rows</span>
        <span class="n">cols_sorted</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">CustomFieldDefinition</span><span class="p">)]</span> <span class="o">+</span>
            <span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">,</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">,</span> <span class="s1">&#39;region&#39;</span><span class="p">,</span> <span class="s1">&#39;period&#39;</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">cols_sorted</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols_sorted</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cols_sorted</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span> \
            <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols_sorted</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df</span> <span class="ow">and</span> <span class="n">c</span> <span class="o">!=</span> <span class="s1">&#39;value&#39;</span><span class="p">])</span> \
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># round values</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">cell</span><span class="p">:</span> <span class="n">cell</span> <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="k">else</span> <span class="nb">round</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span> <span class="n">sigfigs</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">warn</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># insert column containing units</span>
        <span class="n">df</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">),</span> <span class="s1">&#39;unit&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;reference_variable&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">combine_units</span><span class="p">(</span><span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]],</span> <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]])</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">])</span> <span class="k">else</span>
                            <span class="n">var_units</span><span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]],</span>
                <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">var_units</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="python.posted.noslag.DataSet.data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">data</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>str: Get or set dataframe</p>
    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="python.posted.noslag.DataSet.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">parent_variable</span><span class="p">,</span> <span class="n">include_databases</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_paths</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">check_inconsistencies</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Initialise parent class and fields, load data from specified databases and files</p>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
             <span class="n">parent_variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
             <span class="n">include_databases</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">file_paths</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">check_inconsistencies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
             <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Initialise parent class and fields, load data from specified databases and files</span>


<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">TEBase</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent_variable</span><span class="p">)</span>

    <span class="c1"># initialise fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">base_columns</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">col_id</span><span class="p">:</span> <span class="n">field</span>
        <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">AbstractFieldDefinition</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Load data if provided, otherwise load from TEDataFiles</span>
    <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># read TEDataFiles and combine into dataset</span>
        <span class="n">include_databases</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">include_databases</span><span class="p">)</span> <span class="k">if</span> <span class="n">include_databases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">list</span><span class="p">(</span><span class="n">databases</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_files</span><span class="p">(</span><span class="n">include_databases</span><span class="p">,</span> <span class="n">file_paths</span> <span class="ow">or</span> <span class="p">[],</span> <span class="n">check_inconsistencies</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="python.posted.noslag.DataSet.aggregate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_singular_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extrapolate_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">agg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masks</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">masks_database</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Aggregates data based on specified parameters, applies masks,
and cleans up the resulting DataFrame.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>override</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[dict[str, str]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with key, value paris of variables to override</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>drop_singular_fields</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, drop custom fields with only one value</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>extrapolate_period</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, extrapolate values by extrapolation, if no value for this period is given</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>agg</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[str | list[str] | tuple[str]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specifies which fields to aggregate over.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>masks</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[list[<span title="posted.masking.Mask">Mask</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specifies a list of Mask objects that will be applied to the data during aggregation.
These masks can be used to filter or weight the
data based on certain conditions defined in the Mask objects.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>masks_database</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Determines whether to include masks from databases in the aggregation process.
If set to <code>True</code>, masks from databases will be included along with any masks provided as function arguments.
If set to <code>False</code>, only the masks provided as function argruments will be applied</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The <code>aggregate</code> method returns a pandas DataFrame that has been cleaned up and aggregated based
on the specified parameters and input data. The method performs aggregation over component
fields and cases fields, applies weights based on masks, drops rows with NaN weights, aggregates
with weights, inserts reference variables, sorts columns and rows, rounds values, and inserts
units before returning the final cleaned and aggregated DataFrame.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">drop_singular_fields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">extrapolate_period</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="n">agg</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">masks</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">Mask</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">masks_database</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
              <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Aggregates data based on specified parameters, applies masks,</span>
<span class="sd">    and cleans up the resulting DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    override: Optional[dict[str, str]]</span>
<span class="sd">        Dictionary with key, value paris of variables to override</span>
<span class="sd">    drop_singular_fields: bool, optional</span>
<span class="sd">        If True, drop custom fields with only one value</span>
<span class="sd">    extrapolate_period: bool, optional</span>
<span class="sd">        If True, extrapolate values by extrapolation, if no value for this period is given</span>
<span class="sd">    agg : Optional[str | list[str] | tuple[str]]</span>
<span class="sd">        Specifies which fields to aggregate over.</span>
<span class="sd">    masks : Optional[list[Mask]]</span>
<span class="sd">        Specifies a list of Mask objects that will be applied to the data during aggregation.</span>
<span class="sd">        These masks can be used to filter or weight the</span>
<span class="sd">        data based on certain conditions defined in the Mask objects.</span>
<span class="sd">    masks_database : bool, optional</span>
<span class="sd">        Determines whether to include masks from databases in the aggregation process.</span>
<span class="sd">        If set to `True`, masks from databases will be included along with any masks provided as function arguments.</span>
<span class="sd">        If set to `False`, only the masks provided as function argruments will be applied</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        The `aggregate` method returns a pandas DataFrame that has been cleaned up and aggregated based</span>
<span class="sd">        on the specified parameters and input data. The method performs aggregation over component</span>
<span class="sd">        fields and cases fields, applies weights based on masks, drops rows with NaN weights, aggregates</span>
<span class="sd">        with weights, inserts reference variables, sorts columns and rows, rounds values, and inserts</span>
<span class="sd">        units before returning the final cleaned and aggregated DataFrame.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># get selection</span>
    <span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_references</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span><span class="n">override</span><span class="p">,</span>
                                                       <span class="n">extrapolate_period</span><span class="p">,</span>
                                                       <span class="n">drop_singular_fields</span><span class="p">,</span>
                                                       <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span>

    <span class="c1"># compile masks from databases and function argument into one list</span>
    <span class="k">if</span> <span class="n">masks</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">Mask</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Function argument &#39;masks&#39; must contain a list of posted.masking.Mask objects.&quot;</span><span class="p">)</span>
    <span class="n">masks</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_masks</span> <span class="k">if</span> <span class="n">masks_database</span> <span class="k">else</span> <span class="p">[])</span> <span class="o">+</span> <span class="p">(</span><span class="n">masks</span> <span class="ow">or</span> <span class="p">[])</span>

    <span class="c1"># aggregation</span>
    <span class="n">component_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">field_type</span> <span class="o">==</span> <span class="s1">&#39;component&#39;</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="n">agg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">agg</span> <span class="o">=</span> <span class="n">component_fields</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">agg</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">agg</span> <span class="o">=</span> <span class="p">[</span><span class="n">agg</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field ID in argument &#39;agg&#39; must be a string but found: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">col_id</span> <span class="k">for</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Field ID in argument &#39;agg&#39; is not a valid field: </span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># aggregate over component fields</span>
    <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">selected</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span> <span class="ow">or</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">agg</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">component_fields</span><span class="p">))</span>
    <span class="p">]</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">selected</span> \
        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">agg</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;sum&#39;</span><span class="p">})</span> \
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># aggregate over cases fields</span>
    <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="s1">&#39;value&#39;</span> <span class="ow">or</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">agg</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">keys</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># set default weights to 1.0</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">rows</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">weight</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># update weights by applying masks</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">matches</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
                <span class="n">rows</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">mask</span><span class="o">.</span><span class="n">get_weights</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>

        <span class="c1"># drop all rows with weights equal to nan</span>
        <span class="n">rows</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">rows</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="c1"># aggregate with weights</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">rows</span> \
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="n">dropna</span><span class="o">=</span><span class="kc">False</span><span class="p">)[[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;weight&#39;</span><span class="p">]]</span> \
                <span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">cols</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">({</span>
                    <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">],</span> <span class="n">weights</span><span class="o">=</span><span class="n">cols</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">]),</span>
                <span class="p">}))</span>

            <span class="c1"># add to return list</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="n">aggregated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

    <span class="c1"># insert reference variables</span>
    <span class="n">var_ref_unique</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">var_references</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">var_references</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
    <span class="p">}</span>
    <span class="n">agg_append</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ref_var</span> <span class="ow">in</span> <span class="n">var_ref_unique</span><span class="p">:</span>
        <span class="n">agg_append</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
            <span class="s1">&#39;variable&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ref_var</span><span class="p">],</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">],</span>
        <span class="p">}</span> <span class="o">|</span> <span class="p">{</span>
            <span class="n">col_id</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">col_id</span> <span class="ow">in</span> <span class="n">aggregated</span>
        <span class="p">}))</span>
    <span class="k">if</span> <span class="n">agg_append</span><span class="p">:</span>
        <span class="n">agg_append</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">agg_append</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">aggregated</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">agg_append</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">select_and_expand</span><span class="p">(</span><span class="n">agg_append</span><span class="p">,</span> <span class="n">col_id</span><span class="p">,</span> <span class="n">aggregated</span><span class="p">[</span><span class="n">col_id</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">agg_append</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># convert return list to dataframe, reset index, and clean up</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">aggregated</span><span class="p">,</span> <span class="n">agg_append</span><span class="p">]),</span> <span class="n">var_units</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="python.posted.noslag.DataSet.normalise" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalise</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>normalise data: default reference units, reference value equal to 1.0, default reported units</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>override</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[dict[str, str]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with key, value pairs of variables to override</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>inplace</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Wether to do the normalisation in place</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if inplace is false, returns normalised dataframe</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">inplace</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    normalise data: default reference units, reference value equal to 1.0, default reported units</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    override: Optional[dict[str,str]], optional</span>
<span class="sd">        Dictionary with key, value pairs of variables to override</span>
<span class="sd">    inplace: bool, optional</span>
<span class="sd">        Wether to do the normalisation in place</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        if inplace is false, returns normalised dataframe&#39;&#39;&#39;</span>
    <span class="n">normalised</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalise</span><span class="p">(</span><span class="n">override</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">inplace</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_df</span> <span class="o">=</span> <span class="n">normalised</span>
        <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">normalised</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="python.posted.noslag.DataSet.select" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select</span><span class="p">(</span><span class="n">override</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">drop_singular_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">extrapolate_period</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Select desired data from the dataframe</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>override</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[dict[str, str]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with key, value paris of variables to override</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>drop_singular_fields</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, drop custom fields with only one value</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>extrapolate_period</code></td>
            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, extrapolate values by extrapolation, if no value for this period is given</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>**field_vals_select</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>IDs of values to select</p>
              </div>
            </td>
            <td>
                  <code>{}</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with selected Values</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
           <span class="n">drop_singular_fields</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
           <span class="n">extrapolate_period</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
           <span class="o">**</span><span class="n">field_vals_select</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Select desired data from the dataframe</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    override: Optional[dict[str, str]]</span>
<span class="sd">        Dictionary with key, value paris of variables to override</span>
<span class="sd">    drop_singular_fields: bool, optional</span>
<span class="sd">        If True, drop custom fields with only one value</span>
<span class="sd">    extrapolate_period: bool, optional</span>
<span class="sd">        If True, extrapolate values by extrapolation, if no value for this period is given</span>
<span class="sd">    **field_vals_select</span>
<span class="sd">        IDs of values to select</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pd.DataFrame</span>
<span class="sd">        DataFrame with selected Values</span>
<span class="sd">        &#39;&#39;&#39;</span>
    <span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_references</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_select</span><span class="p">(</span>
        <span class="n">override</span><span class="p">,</span>
        <span class="n">drop_singular_fields</span><span class="p">,</span>
        <span class="n">extrapolate_period</span><span class="p">,</span>
        <span class="o">**</span><span class="n">field_vals_select</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">selected</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">selected</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;variable&#39;</span><span class="p">),</span> <span class="s1">&#39;reference_variable&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;reference_variable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">var_references</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cleanup</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">var_units</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="python.posted.noslag.HarmoniseMappingFailure" class="doc doc-heading">
            <code>HarmoniseMappingFailure</code>


</h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code>Warning</code></p>


      <p>Warning raised for rows in TEDataSets where mappings fail.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>row_data</code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contains the Data on the rows to map</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>message</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Contains the message of the failure</p>
              </div>
            </td>
            <td>
                  <code>&#39;Failure when selecting from dataset.&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="python.posted.noslag.HarmoniseMappingFailure.row_data">row_data</span></code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the data of the row that causes the failure</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="python.posted.noslag.HarmoniseMappingFailure.message">message</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>explanation of the error</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>python/posted/noslag.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">HarmoniseMappingFailure</span><span class="p">(</span><span class="ne">Warning</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Warning raised for rows in TEDataSets where mappings fail.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    row_data: pd.DataFrame</span>
<span class="sd">        Contains the Data on the rows to map</span>
<span class="sd">    message: str, optional</span>
<span class="sd">        Contains the message of the failure</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    row_data</span>
<span class="sd">        the data of the row that causes the failure</span>
<span class="sd">    message</span>
<span class="sd">        explanation of the error</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Failure when selecting from dataset.&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Save constructor arguments as public fields, compose warning message, call super constructor&#39;&#39;&#39;</span>
        <span class="c1"># save constructor arguments as public fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">row_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">message</span>

        <span class="c1"># compose warning message</span>
        <span class="n">warning_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">row_data</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># call super constructor</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="python.posted.noslag.HarmoniseMappingFailure.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">row_data</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s1">&#39;Failure when selecting from dataset.&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Save constructor arguments as public fields, compose warning message, call super constructor</p>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Failure when selecting from dataset.&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Save constructor arguments as public fields, compose warning message, call super constructor&#39;&#39;&#39;</span>
    <span class="c1"># save constructor arguments as public fields</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">row_data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">message</span>

    <span class="c1"># compose warning message</span>
    <span class="n">warning_message</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">message</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">row_data</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># call super constructor</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">warning_message</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="python.posted.noslag.collect_files" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">collect_files</span><span class="p">(</span><span class="n">parent_variable</span><span class="p">,</span> <span class="n">include_databases</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Takes a parent variable and optional list of databases to include,
checks for their existence, and collects files and directories based on the parent variable.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>parent_variable</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Variable to collect files on</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>include_databases</code></td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[list[str]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of Database IDs to collect files from</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>    list[tuple]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <pre><code>List of tuples containing the parent variable and the
</code></pre>
<p>database ID for each file found in the specified directories.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">collect_files</span><span class="p">(</span><span class="n">parent_variable</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">include_databases</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Takes a parent variable and optional list of databases to include,</span>
<span class="sd">    checks for their existence, and collects files and directories based on the parent variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parent_variable : str</span>
<span class="sd">        Variable to collect files on</span>
<span class="sd">    include_databases : Optional[list[str]]</span>
<span class="sd">        List of Database IDs to collect files from</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        list[tuple]</span>
<span class="sd">            List of tuples containing the parent variable and the</span>
<span class="sd">        database ID for each file found in the specified directories.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parent_variable</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Variable may not me empty.&#39;</span><span class="p">)</span>

    <span class="c1"># check that the requested database to include can be found</span>
    <span class="k">if</span> <span class="n">include_databases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">database_id</span> <span class="ow">in</span> <span class="n">include_databases</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">database_id</span> <span class="ow">in</span> <span class="n">databases</span> <span class="ow">and</span> <span class="n">databases</span><span class="p">[</span><span class="n">database_id</span><span class="p">]</span><span class="o">.</span><span class="n">exists</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not find database &#39;</span><span class="si">{</span><span class="n">database_id</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">database_id</span><span class="p">,</span> <span class="n">database_path</span> <span class="ow">in</span> <span class="n">databases</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># skip ted paths not requested to include</span>
        <span class="k">if</span> <span class="n">include_databases</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">database_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_databases</span><span class="p">:</span> <span class="k">continue</span>

        <span class="c1"># find top-level file and directory</span>
        <span class="n">top_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">))</span>
        <span class="n">top_file</span> <span class="o">=</span> <span class="n">database_path</span> <span class="o">/</span> <span class="s1">&#39;tedfs&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">top_path</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
        <span class="n">top_directory</span> <span class="o">=</span> <span class="n">database_path</span> <span class="o">/</span> <span class="s1">&#39;tedfs&#39;</span> <span class="o">/</span> <span class="n">top_path</span>

        <span class="c1"># add top-level file if it exists</span>
        <span class="k">if</span> <span class="n">top_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">top_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_variable</span><span class="p">,</span> <span class="n">database_id</span><span class="p">))</span>

        <span class="c1"># add all files contained in top-level directory</span>
        <span class="k">if</span> <span class="n">top_directory</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">top_directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sub_file</span> <span class="ow">in</span> <span class="n">top_directory</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s1">&#39;*.csv&#39;</span><span class="p">):</span>
                <span class="n">sub_variable</span> <span class="o">=</span> <span class="n">parent_variable</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="n">sub_file</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">top_directory</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sub_variable</span><span class="p">,</span> <span class="n">database_id</span><span class="p">))</span>

        <span class="c1"># loop over levels</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="n">parent_variable</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">levels</span><span class="p">)):</span>
            <span class="c1"># find top-level file and directory</span>
            <span class="n">top_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">levels</span><span class="p">[:</span><span class="n">l</span><span class="p">])</span>
            <span class="n">parent_file</span> <span class="o">=</span> <span class="n">database_path</span> <span class="o">/</span> <span class="s1">&#39;tedfs&#39;</span> <span class="o">/</span> <span class="p">(</span><span class="n">top_path</span> <span class="o">+</span> <span class="s1">&#39;.csv&#39;</span><span class="p">)</span>

            <span class="c1"># add parent file if it exists</span>
            <span class="k">if</span> <span class="n">parent_file</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">and</span> <span class="n">parent_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="n">parent_variable</span> <span class="o">=</span> <span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">levels</span><span class="p">[:</span><span class="n">l</span><span class="p">])</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">parent_variable</span><span class="p">,</span> <span class="n">database_id</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ret</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="python.posted.noslag.combine_units" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">combine_units</span><span class="p">(</span><span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Combine fraction of two units into updated unit string</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>numerator</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>numerator of the fraction</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>denominator</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>denominator of the fraction</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>    str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>updated unit string after simplification</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">combine_units</span><span class="p">(</span><span class="n">numerator</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">denominator</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Combine fraction of two units into updated unit string</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    numerator: str</span>
<span class="sd">        numerator of the fraction</span>
<span class="sd">    denominator: str</span>
<span class="sd">        denominator of the fraction</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        str</span>
<span class="sd">            updated unit string after simplification</span>
<span class="sd">    &#39;&#39;&#39;</span>


    <span class="n">ret</span> <span class="o">=</span> <span class="n">ureg</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numerator</span><span class="si">}</span><span class="s2">/(</span><span class="si">{</span><span class="n">denominator</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">u</span>
    <span class="c1"># chekc if ret is dimensionless, if not return ret, else return the explicit quotient</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="o">.</span><span class="n">dimensionless</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numerator</span><span class="si">}</span><span class="s2">/(</span><span class="si">{</span><span class="n">denominator</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="k">if</span> <span class="s1">&#39;/&#39;</span> <span class="ow">in</span> <span class="n">denominator</span> <span class="k">else</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">numerator</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">denominator</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="python.posted.noslag.normalise_units" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalise_units</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> <span class="n">var_units</span><span class="p">,</span> <span class="n">var_flow_ids</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Takes a DataFrame with reported or reference data, along with
dictionaries mapping variable units and flow IDs, and normalizes the units of the variables in the
DataFrame based on the provided mappings.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>df</code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataframe to be normalised</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>level</code></td>
            <td>
                  <code><span title="typing.Literal">Literal</span>[&#39;reported&#39;, &#39;reference&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Specifies whether the data should be normalised on the reported or reference values</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>var_units</code></td>
            <td>
                  <code>dict[str, str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary that maps a combination of parent variable and variable
to its corresponding unit. The keys in the dictionary are in the format "{parent_variable}|{variable}",
and the values are the units associated with that variable.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>var_flow_ids</code></td>
            <td>
                  <code>dict[str, str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary that maps a combination of parent variable and variable to a
specific flow ID. This flow ID is used for unit conversion in the <code>normalise_units</code> function.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>    pd.DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Normalised dataframe</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalise_units</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s1">&#39;reported&#39;</span><span class="p">,</span> <span class="s1">&#39;reference&#39;</span><span class="p">],</span> <span class="n">var_units</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
                       <span class="n">var_flow_ids</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Takes a DataFrame with reported or reference data, along with</span>
<span class="sd">    dictionaries mapping variable units and flow IDs, and normalizes the units of the variables in the</span>
<span class="sd">    DataFrame based on the provided mappings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dataframe to be normalised</span>
<span class="sd">    level : Literal[&#39;reported&#39;, &#39;reference&#39;]</span>
<span class="sd">        Specifies whether the data should be normalised on the reported or reference values</span>
<span class="sd">    var_units : dict[str, str]</span>
<span class="sd">        Dictionary that maps a combination of parent variable and variable</span>
<span class="sd">        to its corresponding unit. The keys in the dictionary are in the format &quot;{parent_variable}|{variable}&quot;,</span>
<span class="sd">        and the values are the units associated with that variable.</span>
<span class="sd">    var_flow_ids : dict[str, str]</span>
<span class="sd">        Dictionary that maps a combination of parent variable and variable to a</span>
<span class="sd">        specific flow ID. This flow ID is used for unit conversion in the `normalise_units` function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Normalised dataframe</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;reported&#39;</span> <span class="k">else</span> <span class="s1">&#39;reference_&#39;</span>
    <span class="n">var_col_id</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;variable&#39;</span>
    <span class="n">value_col_id</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;value&#39;</span>
    <span class="n">unit_col_id</span> <span class="o">=</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;unit&#39;</span>
    <span class="n">df_tmp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
        <span class="n">df</span><span class="p">,</span>
        <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">var_units</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parent_variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">var_col_id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">var_col_id</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;target_unit&#39;</span><span class="p">),</span>
        <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">var_flow_ids</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;parent_variable&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">|</span><span class="si">{</span><span class="n">row</span><span class="p">[</span><span class="n">var_col_id</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">var_col_id</span><span class="p">],</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">to_frame</span><span class="p">(</span><span class="s1">&#39;target_flow_id&#39;</span><span class="p">),</span>
    <span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Apply unit conversion</span>
    <span class="n">conv_factor</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">unit_convert</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">unit_col_id</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_unit&#39;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;target_flow_id&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">value_col_id</span><span class="p">])</span> <span class="k">else</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Update value column with conversion factor</span>
    <span class="n">df_tmp</span><span class="p">[</span><span class="n">value_col_id</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conv_factor</span>

    <span class="c1"># If level is &#39;reported&#39;, update uncertainty column with conversion factor</span>
    <span class="k">if</span> <span class="n">level</span> <span class="o">==</span> <span class="s1">&#39;reported&#39;</span><span class="p">:</span>
        <span class="n">df_tmp</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">conv_factor</span>

    <span class="c1"># Uupdate unit columns</span>
    <span class="n">df_tmp</span><span class="p">[</span><span class="n">unit_col_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_tmp</span><span class="p">[</span><span class="s1">&#39;target_unit&#39;</span><span class="p">]</span>

    <span class="c1"># Drop unneccessary columns and return</span>
    <span class="k">return</span> <span class="n">df_tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;target_unit&#39;</span><span class="p">,</span> <span class="s1">&#39;target_flow_id&#39;</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="python.posted.noslag.normalise_values" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">normalise_values</span><span class="p">(</span><span class="n">df</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

      <p>Takes a DataFrame as input, normalizes the 'value' and 'uncertainty'
columns by the reference value, and updates the 'reference_value' column accordingly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>df</code></td>
            <td>
                  <code><span title="pandas.DataFrame">DataFrame</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dataframe to be normalised</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>    pd.DataFrame</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Returns a modified DataFrame where the 'value' column has been
divided by the 'reference_value' column (or 1.0 if 'reference_value' is null), the 'uncertainty'
column has been divided by the 'reference_value' column, and the 'reference_value' column has been
replaced with 1.0 if it was not null, otherwise</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>python/posted/noslag.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">normalise_values</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Takes a DataFrame as input, normalizes the &#39;value&#39; and &#39;uncertainty&#39;</span>
<span class="sd">    columns by the reference value, and updates the &#39;reference_value&#39; column accordingly.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pd.DataFrame</span>
<span class="sd">        Dataframe to be normalised</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            Returns a modified DataFrame where the &#39;value&#39; column has been</span>
<span class="sd">            divided by the &#39;reference_value&#39; column (or 1.0 if &#39;reference_value&#39; is null), the &#39;uncertainty&#39;</span>
<span class="sd">            column has been divided by the &#39;reference_value&#39; column, and the &#39;reference_value&#39; column has been</span>
<span class="sd">            replaced with 1.0 if it was not null, otherwise</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># Calculate reference value</span>
    <span class="n">reference_value</span> <span class="o">=</span>  <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span>
            <span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_value&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_value&#39;</span><span class="p">])</span> <span class="k">else</span>
            <span class="mf">1.0</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Calculate new value, reference value and uncertainty</span>
    <span class="n">value_new</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">reference_value</span>
    <span class="n">uncertainty_new</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;uncertainty&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="n">reference_value</span>
    <span class="n">reference_value_new</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span>
            <span class="mf">1.0</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isnull</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;reference_value&#39;</span><span class="p">])</span> <span class="k">else</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Assign new values to dataframe and return</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">value_new</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty_new</span><span class="p">,</span> <span class="n">reference_value</span><span class="o">=</span><span class="n">reference_value_new</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      <a href="https://creativecommons.org/licenses/by/4.0/">CC-BY 4.0 2024</a>  P.C. Verpoort
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.tabs.link", "navigation.tabs", "navigation.tabs.sticky", "navigation.path", "navigation.indexes", "toc.integrate"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://unpkg.com/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>